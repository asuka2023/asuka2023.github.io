<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      background: rgba(0, 0, 0, 1);
    }



    #myCanvas {
      position: fixed;
      top: 0;
      background: rgba(0, 0, 0, 0);
      left: 50%;
      transform: translate(-50%);
    }

    .content {
      position: fixed;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      color: #f1f1f1;
      width: 100%;
      padding: 20px;
    }
  </style>


</head>

<body>

  <video id="myVideo" style="display: none"></video>
  <canvas id="myCanvas"></canvas>
  <div class="content">
    <p>訊息:<span id="message" style="color:red;font-weight:bold"></span></p>
    <p>點:<span id="cornerPoints" style="color:red;font-weight:bold"></span></p>
    <p>設備:<select id="mediaDevices" onchange="mediaDevices_onchange()"></select><button class="switch">手電筒</button>
    <p>
    <p>掃瞄範圍，寬:<input type="range" step="10" class="slider" id="scannerW">Value: <span
        id="scannerWvalue"></span>長:<input type="range" step="10" class="slider"
        id="scannerH">Value: <span id="scannerHvalue"></span></p>
  </div>

  <script>
    var scannerw = document.getElementById("scannerW");
    scannerw.value = 100;
    scannerw.min = 100;
    var scannerwvalue = document.getElementById("scannerWvalue");
    showscannerwvalue();
    var scannerh = document.getElementById("scannerH");
    scannerh.value = 100;
    scannerh.min = 100;
    var scannerhvalue = document.getElementById("scannerHvalue");
    showscannerhvalue();
    const mycanvas = document.getElementById('myCanvas');
    const myvideo = document.getElementById('myVideo');
    const btn = document.querySelector('.switch');
    drawImge();
    screen_orientation();
    //document.getElementById('cornerPoints').innerHTML = `畫面放大縮小比例:[${window.visualViewport.scale}],畫面顯示大小:[${myvideo.width},${myvideo.height}],螢幕方向: ${screen.orientation.type}, 旋轉角度:${screen.orientation.angle}`;
    stopCamera();
    if (!navigator.mediaDevices?.enumerateDevices) {
      alert("enumerateDevices() not supported.");
    } else {
      var sel = document.getElementById('mediaDevices');
      var opt = null;
      navigator.mediaDevices
        .enumerateDevices()
        .then((devices) => {
          devices.forEach((device) => {
            //只要相機設備
            if (device.kind == "videoinput") {
              opt = document.createElement('option');
              opt.value = device.deviceId;
              opt.innerHTML = device.label;
              sel.appendChild(opt);
            }
          });
          //相機選單必須要有一個鏡頭以上
          if (sel.length > 0) {
            var selectcamera = localStorage.getItem("CameraId");
            if (selectcamera != null && selectcamera != '') {
              sel.value = selectcamera;
            }
            // 檢查瀏覽器相容性
            if (!("BarcodeDetector" in globalThis)) {
              console.log("此瀏覽器不支援條碼掃描。");
              document.getElementById('message').innerHTML = '此瀏覽器不支援條碼掃描';
            } else {
              console.log("此瀏覽器支援條碼掃描");
              document.getElementById('message').innerHTML = '此瀏覽器支援條碼掃描';

              openCamera();

            }
          }
        })
        .catch((err) => {
          console.error(`${err.name}: ${err.message}`);
          alert(`${err.name}: ${err.message}`);
        });
    }
    //開啟相機
    function openCamera() {
      stopCamera();
      var constraints = {
        audio: false,
        video: { frameRate: { min: 10, max: 30 }, deviceId: document.getElementById("mediaDevices").value, },
      };
      document.getElementById('cornerPoints').innerHTML = `螢幕大小:[${window.visualViewport.width},${window.visualViewport.height}],畫面放大縮小比例:[${window.visualViewport.scale}],畫面顯示大小:[${myvideo.width},${myvideo.height}],螢幕方向: ${screen.orientation.type}, 旋轉角度:${screen.orientation.angle}`;
      navigator.mediaDevices
        .getUserMedia(constraints)
        .then(openCameraSuccess)
        .catch(openCameraError);
    }
    //開啟相機成功
    function openCameraSuccess(mediaStream) {
      myvideo.srcObject = mediaStream;
      //let there be light!
      const btn = document.querySelector('.switch');

    }
    //開啟相機失敗
    function openCameraError(err) {
      console.error(`${err.name}: ${err.message}`);
      document.getElementById('message').innerHTML = `${err.name}: ${err.message}`;
    }
    //關閉相機串流
    function stopCamera() {
      try {
        const stream = myvideo.srcObject;
        if (stream != null) {
          const tracks = stream.getTracks();
          tracks.forEach((track) => {
            track.stop();
          });
          myvideo.srcObject = null;
        }
      } catch (err) {
        console.log(err);
        alert(err);
      }
    }
    //切換相機
    function mediaDevices_onchange() {
      localStorage.setItem("CameraId", document.getElementById("mediaDevices").value);
      openCamera();
    }
    //依照螢幕方向決定影片尺寸
    function screen_orientation() {
      switch (screen.orientation.type) {
        case "landscape-primary":
        case "landscape-secondary":
          mycanvas.style.width = "auto";
          mycanvas.style.height = "100%";
          break;
        case "portrait-secondary":
        case "portrait-primary":
          mycanvas.style.width = "100%";
          mycanvas.style.height = "auto";
          break;
        default:
          console.log("The orientation API isn't supported in this browser :(");
      }
    }
    //渲染畫面
    function drawImge() {
      try {
        const stream = myvideo.srcObject;
        if (stream != null) {
          var ctx = mycanvas.getContext('2d');

          mycanvas.width = myvideo.videoWidth;
          mycanvas.height = myvideo.videoHeight;
          if (scannerw.value > mycanvas.width) {
            scannerw.value = mycanvas.width;
           
          }
           showscannerwvalue();
          scannerw.max = mycanvas.width;
          if (scannerh.value > mycanvas.height) {
            scannerh.value = mycanvas.height;

          } 
          showscannerhvalue();
          scannerh.max = mycanvas.height;

          ctx.drawImage(myvideo, 0, 0, mycanvas.width, mycanvas.height);
          var scannerx = (mycanvas.width - scannerw.value) / 2;
          var scannery = (mycanvas.height - scannerh.value) / 2;
          // Create clipping path
          let region = new Path2D();
          region.rect(0, 0, mycanvas.width, mycanvas.height);
          region.rect(scannerx, scannery, scannerw.value, scannerh.value);
          ctx.clip(region, "evenodd");
          // Draw stuff that gets clipped
          // Turn transparency on
          ctx.globalAlpha = 0.5;
          ctx.fillStyle = "black";
          ctx.fillRect(0, 0, mycanvas.width, mycanvas.height);
          //擷取出要掃描的區域
          const myImageData = ctx.getImageData(scannerx, scannery, scannerw.value, scannerh.value);
          // 建立條碼種類
          var barcodeDetector = new BarcodeDetector({
            formats: ["code_128", "qr_code"],
          });
          //檢測條碼
          barcodeDetector
            .detect(myImageData)
            .then((barcodes) => {
              var cornerPoints = '';
              var result = '';
              ctx.rect(scannerx, scannery, scannerw.value, scannerh.value);
              ctx.lineWidth = "10";
              ctx.strokeStyle = "red";
              //當檢測出符合條碼的種類邊框變綠色，不符合紅色
              if (barcodes.length > 0) {
                var barcode = barcodes[0];
                result += ` ${barcode.rawValue}, `;
                cornerPoints += ` [${barcode.boundingBox.x}, ${barcode.boundingBox.y},${barcode.boundingBox.width},${barcode.boundingBox.height}]  `;
                cornerPoints += `,[${mycanvas.offsetWidth},${mycanvas.offsetHeight}],[${myvideo.videoWidth},${myvideo.videoHeight}] `;
                ctx.strokeStyle = "green";
              }

              ctx.stroke();
              document.getElementById('message').innerHTML = `條碼:${result} `;
              document.getElementById('cornerPoints').innerHTML = cornerPoints;
              //document.getElementById('cornerPoints').innerHTML= `畫面顯示大小:[${myvideo.width},${myvideo.height}],相機畫面大小:[${myvideo.videoWidth},${myvideo.videoHeight}]`;
            })
            .catch((err) => {
              console.log(err);
            });
        }
        else {
          mycanvas.width = window.visualViewport.width;
          mycanvas.height = window.visualViewport.height;
        }
      } catch (err) {
        console.log(err);
        alert(err);
      }
      finally {
        setTimeout(drawImge, 100);
      }


    }
    //顯示掃描區域寬度數值
    function showscannerwvalue() {
      scannerwvalue.innerHTML = scannerw.value;

    }
    //顯示掃描區域長度數值
    function showscannerhvalue() {
      scannerhvalue.innerHTML = scannerh.value;
    }
    //當使用者移動掃描區域寬度
    scannerw.addEventListener("input", (event) => {
      showscannerwvalue();
    });
    //當使用者移動掃描區域高度
    scannerw.addEventListener("input", (event) => {
      showscannerhvalue();
    });
    //監聽影片元件有資料進入就撥放，
    myvideo.addEventListener("loadedmetadata", (event) => {
      myvideo.play();


    });
    //監聽瀏覽器螢幕方向
    screen.orientation.addEventListener("change", (event) => {
      screen_orientation();
      openCamera();
    });
    //監聽按鈕手電筒，如果手機有多顆鏡頭不會每個鏡頭都能開手電筒
    btn.addEventListener('click', function () {
      try {
        const stream = myvideo.srcObject;
        if (stream != null) {
          const track = stream.getVideoTracks()[0];
          track.applyConstraints({
            advanced: [{ torch: true }]
          });
        }
      } catch (err) {
        console.log(err);
        alert(err);
      }
    }); 
  </script>
</body>

</html>
